<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="logo.png" />
    <title>Peminjaman Buku</title>

    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --card: #1f2937;
        --muted: #64748b;
        --text: #e5e7eb;
        --accent: #22c55e;
        --accent-2: #60a5fa;
        --danger: #ef4444;
        --warn: #f59e0b;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 16px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui;
        background: linear-gradient(135deg, var(--bg), #020617);
        color: var(--text);
      }
      img {
        width: 40px;
        height: 40px;
      }
      .container {
        max-width: 1100px;
        margin: 36px auto;
        padding: 0 16px;
      }
      header {
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .title {
        font-size: clamp(22px, 3.6vw, 34px);
        font-weight: 800;
      }
      .subtitle {
        color: var(--muted);
        font-size: 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 980px) {
        .grid {
          grid-template-columns: 420px 1fr;
        }
      }
      .card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow);
      }
      .card h2 {
        margin: 0.2rem 0 1rem;
      }
      .row,
      .row-3 {
        display: grid;
        gap: 12px;
      }
      .row {
        grid-template-columns: 1fr 1fr;
      }
      .row-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
      label {
        font-size: 13px;
        color: var(--muted);
        display: block;
        margin: 6px 0;
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: #0b1324;
        color: var(--text);
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: 0;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-primary {
        background: var(--accent);
        color: #052e16;
      }
      .btn-secondary {
        background: #0b1324;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
      }
      .btn-danger {
        background: var(--danger);
        color: #210000;
      }
      .btn-warn {
        background: var(--warn);
        color: #1f1300;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.08);
      }
      th {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
      }
      .badge {
        display: inline-flex;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .badge.ok {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #b7f7c8;
      }
      .badge.late {
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #fecaca;
      }
      .right {
        text-align: right;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div>
          <div class="title">
            <img src="logo.png" /> Sistem Peminjaman Buku Perpustakaan
          </div>
          <div class="subtitle">Tanpa login & database — pakai LocalStorage</div>
        </div>
        <div class="toolbar">
          <button id="btnExportCSV" class="btn-secondary">Export CSV</button>
          <button id="btnReset" class="btn-danger">Reset Semua Data</button>
        </div>
      </header>

      <div class="grid">
        
        <!-- FORM -->
        <section class="card">
          <h2>Tambah Peminjaman</h2>
          <form id="loanForm">
            <label>Nama <input id="borrower" required /></label>

            <div class="row">
              <label>Kelas
                <select id="kelas" required>
                  <option value="">— pilih kelas —</option>
                  <option>X RPL</option>
                  <option>XI RPL</option>
                  <option>XII RPL</option>
                </select>
              </label>

              <label>Pelajaran / Guru
                <input id="subject" required />
              </label>
            </div>

            <div class="row-3">
              <label>Jumlah
                <input id="qty" type="number" value="1" min="1" required />
              </label>

              <label>Tgl Pinjam
                <input id="borrowDate" type="date" required />
              </label>

              <label>Jatuh Tempo
                <input id="dueDate" type="date" required />
              </label>
            </div>

            <div class="actions">
              <button class="btn-primary" type="submit">Simpan</button>
              <button id="btnToday" type="button" class="btn-secondary">
                Auto Hari Ini + 7
              </button>
            </div>
          </form>
        </section>

        <!-- ACTIVE TABLE -->
        <section class="card">
          <h2>Peminjaman Aktif</h2>
          <table id="activeTable">
            <thead>
              <tr>
                <th>Nama</th>
                <th>Kelas</th>
                <th>Guru</th>
                <th class="right">Jml</th>
                <th>Pinjam</th>
                <th>Due</th>
                <th>Status</th>
                <th class="right">Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>

      <!-- HISTORY -->
      <section class="card" style="margin-top: 16px">
        <h2>Riwayat Pengembalian</h2>

        <table id="historyTable">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Kelas</th>
              <th>Guru</th>
              <th class="right">Jml</th>
              <th>Pinjam</th>
              <th>Due</th>
              <th>Kembali</th>
              <th class="right">Telat</th>
              <th class="right">Denda</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button id="btnClearHistory" class="btn-warn" style="margin-top: 12px">
          Hapus Riwayat
        </button>
      </section>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);
      const activeTBody = $("#activeTable tbody");
      const historyTBody = $("#historyTable tbody");

      const KEY_ACTIVE = "lib_loans_v1";
      const KEY_HISTORY = "lib_history_v1";

      let loans = JSON.parse(localStorage.getItem(KEY_ACTIVE) || "[]");
      let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");

      function fmt(d) {
        return new Date(d).toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      }

      function save() {
        localStorage.setItem(KEY_ACTIVE, JSON.stringify(loans));
        localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
      }

      /*
        ================================
        FIXED STATUS & TELAT
        ================================
      */
      function render() {
        if (!loans.length) {
          activeTBody.innerHTML =
            "<tr><td colspan='8' class='muted'>Belum ada data.</td></tr>";
        } else {
          activeTBody.innerHTML = loans
            .map((l) => {
              const now = new Date();
              const borrow = new Date(l.borrowDate);

              // HITUNG TELAT FIX SESUAI PERMINTAAN
              const daysUsed = Math.ceil((now - borrow) / 86400000);
              const late = Math.max(0, daysUsed - 7);

              const status = late
                ? `<span class='badge late'>Terlambat ${late}h</span>`
                : `<span class='badge ok'>Aman</span>`;

              return `<tr>
                <td>${l.borrower}</td>
                <td>${l.kelas}</td>
                <td>${l.subject}</td>
                <td class='right'>${l.qty}</td>
                <td>${fmt(l.borrowDate)}</td>
                <td>${fmt(l.dueDate)}</td>
                <td>${status}</td>
                <td class='right'>
                  <button class='btn-primary' onclick="returnLoan('${l.id}')">Kembalikan</button>
                  <button class='btn-danger' onclick="deleteLoan('${l.id}')">Hapus</button>
                </td>
              </tr>`;
            })
            .join("");
        }

        // HISTORY
        if (!history.length) {
          historyTBody.innerHTML =
            "<tr><td colspan='10' class='muted'>Belum ada riwayat.</td></tr>";
        } else {
          historyTBody.innerHTML = history
            .map((h) => {
              return `<tr>
                <td>${h.borrower}</td>
                <td>${h.kelas}</td>
                <td>${h.subject}</td>
                <td class='right'>${h.qty}</td>
                <td>${fmt(h.borrowDate)}</td>
                <td>${fmt(h.dueDate)}</td>
                <td>${fmt(h.returnDate)}</td>
                <td class='right'>${h.late}</td>
                <td class='right'>Rp ${h.fee}</td>
                <td><button class='btn-danger' onclick="deleteHistory('${h.id}')">Hapus</button></td>
              </tr>`;
            })
            .join("");
        }

        save();
      }

      window.addEventListener("load", () => {
        const t = new Date();
        $("#borrowDate").value = t.toISOString().slice(0, 10);

        const due = new Date();
        due.setDate(due.getDate() + 7);
        $("#dueDate").value = due.toISOString().slice(0, 10);
      });

      render();

      $("#loanForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const data = {
          id: crypto.randomUUID(),
          borrower: $("#borrower").value,
          kelas: $("#kelas").value,
          subject: $("#subject").value,
          qty: +$("#qty").value,
          borrowDate: $("#borrowDate").value,
          dueDate: $("#dueDate").value,
        };

        loans.unshift(data);
        render();
        e.target.reset();
        window.dispatchEvent(new Event("load"));
      });

      window.deleteLoan = (id) => {
        if (!confirm("Hapus peminjaman?")) return;
        loans = loans.filter((x) => x.id !== id);
        render();
      };

      window.returnLoan = (id) => {
        const l = loans.find((x) => x.id === id);
        if (!l) return;

        const ret = prompt(
          "Tanggal kembali (YYYY-MM-DD):",
          new Date().toISOString().slice(0, 10)
        );
        if (!ret) return;

        // hitung telat kembali
        const borrow = new Date(l.borrowDate);
        const daysUsed = Math.ceil(
          (new Date(ret) - borrow) / 86400000
        );
        const late = Math.max(0, daysUsed - 7);
        const fee = late * 500;

        history.unshift({
          id: crypto.randomUUID(),
          ...l,
          returnDate: ret,
          late,
          fee,
        });
        loans = loans.filter((x) => x.id !== id);

        alert(
          late ? `Telat ${late} hari. Denda: Rp ${fee}` : "Tepat waktu."
        );
        render();
      };

      window.deleteHistory = (id) => {
        if (!confirm("Hapus riwayat ini?")) return;
        history = history.filter((x) => x.id !== id);
        render();
      };

      $("#btnReset").addEventListener("click", () => {
        if (!confirm("Hapus semua data?")) return;
        loans = [];
        history = [];
        render();
      });

      $("#btnClearHistory").addEventListener("click", () => {
        if (!confirm("Hapus semua riwayat?")) return;
        history = [];
        render();
      });

      $("#btnToday").addEventListener("click", () => {
        const t = new Date();
        $("#borrowDate").value = t.toISOString().slice(0, 10);
        t.setDate(t.getDate() + 7);
        $("#dueDate").value = t.toISOString().slice(0, 10);
      });
    </script>
  </body>
</html>

